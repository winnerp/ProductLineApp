<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title></title>
    <link href="css/jquery.mobile-1.2.0.min.css" rel="stylesheet" type="text/css" />
    <script src="js/jquery-1.8.2.js" type="text/javascript"></script>
    <script src="js/jquery.mobile-1.2.0.js" type="text/javascript"></script>
    <script src="js/jqm.page.params.js" type="text/javascript"></script>
    <script src="js/jquery.formatCurrency-1.4.0.js" type="text/javascript"></script>
    <script src="js/purl.js" type="text/javascript"></script>
    <script src="js/Base64.js" type="text/javascript"></script>
    <script src="js/json2.js" type="text/javascript"></script>
    <script src="js/ProdLine.Utils.js" type="text/javascript"></script>
    <script src="js/ProdLine.Shared.js" type="text/javascript"></script>
    <script src="js/ProdLine.Provider.js" type="text/javascript"></script>
</head>
<body>
    <div id="pgMyProfile" data-role="page" data-theme="d">
        <div data-role="header" data-theme="b">
            <a href="index.html" class="ui-btn-left" data-icon="home" data-role="button" data-theme="b"
                data-iconpos="notext" data-transition="slide"></a>
            <h1>
                Product Line</h1>
            <div style="padding: .5em; background-color: #C0C0C0">
                <div data-role="navbar">
                    <fieldset class="ui-grid-b">
                        <div class="ui-block-a" style="margin-left: 0px; margion-right: 0px">
                            <a data-theme="d" href="#" class="ui-corner-left ui-btn-active" data-corners="true"
                                style="width: 100%; margin-left: 0px; margin-right: 0px" data-role="button" data-theme="d"
                                data-icon="star" data-iconpos="top">My Profile</a>
                        </div>
                        <div class="ui-block-b" style="margin-left: 0px; margion-right: 0px">
                            <a data-theme="d" href="PaymentSetup.htm" style="width: 100%; margin-left: 0px; margin-right: 0px"
                                data-role="button" data-theme="d" data-icon="gear" data-iconpos="top">Payment Setup</a>
                        </div>
                        <div class="ui-block-c" style="margin-left: 0px; margion-right: 0px">
                            <a data-theme="d" href="MyOrders.htm" class="ui-corner-right ui-controlgroup-last"
                                data-corners="true" style="width: 100%; margin-left: 0px; margin-right: 0px"
                                data-role="button" data-theme="d" data-icon="grid" data-iconpos="top">My Orders</a>
                        </div>
                    </fieldset>
                </div>
            </div>
        </div>
        <div data-role="content" data-theme="d">
            <div id="dvProfileInfo" style="display: none">
                <div data-role="collapsible-set">
                    <div data-role="collapsible" data-collapsed="false">
                        <h3 class="col_Head blockHeading">
                            Registration Info</h3>
                        <div id="dvRegInfoReadOnly" class="ui-grid-a">
                            <div class="ui-block-a" style="padding: 0.5em 0.5em 0.5em 0.5em">
                                First Name:</div>
                            <div id="fn" class="ui-block-b" style="padding: 0.5em 0.5em 0.5em 0.5em">
                            </div>
                            <div class="ui-block-a" style="padding: 0.5em 0.5em 0.5em 0.5em">
                                Last Name:</div>
                            <div id="ln" class="ui-block-b" style="padding: 0.5em 0.5em 0.5em 0.5em">
                            </div>
                            <div class="ui-block-a" style="padding: 0.5em 0.5em 0.5em 0.5em">
                                Email:</div>
                            <div id="em" class="ui-block-b" style="padding: 0.5em 0.5em 0.5em 0.5em">
                            </div>
                            <div class="ui-block-a" style="padding: 0.5em 0.5em 0.5em 0.0em">
                                <a id="lnkEditRegInfo" href="#" data-role="button" data-inline="true" data-transition="flow"
                                    data-theme="b" data-mini="true">Edit</a>
                            </div>
                        </div>
                        <div id="dvRegInfoEdit" class="ui-grid-a" style="display: none">
                            <div class="ui-block-a" style="padding: 0.5em 0.5em 0.5em 0.5em">
                                First Name:</div>
                            <input id="fnEdit" class="ui-block-b" style="padding: 0.5em 0.5em 0.5em 0.5em" data-mini="true" />
                            <div class="ui-block-a" style="padding: 0.5em 0.5em 0.5em 0.5em">
                                Last Name:</div>
                            <input id="lnEdit" class="ui-block-b" style="padding: 0.5em 0.5em 0.5em 0.5em" data-mini="true" />
                            <div class="ui-block-a" style="padding: 0.5em 0.5em 0.5em 0.5em">
                                Email:</div>
                            <div id="emEdit" class="ui-block-b" style="padding: 0.5em 0.5em 0.5em 0.5em">
                            </div>
                            <div class="ui-block-a" style="padding: 0.5em 0.5em 0.5em 0.0em">
                                <div id="lblRegInfoSaveMsg" style="display: none; color: #8B0000;">
                                    Try Again!</div>
                                <a id="lnkSaveRegInfo" href="#" data-role="button" data-inline="true" data-transition="flow"
                                    data-theme="b" data-mini="true">Save</a> <a id="lnkCancelEditRegInfo" href="#" data-role="button"
                                        data-inline="true" data-transition="flow" data-theme="b" data-mini="true">Cancel</a>
                            </div>
                        </div>
                    </div>
                    <div data-role="collapsible" data-collapsed="true">
                        <h3 class="col_Head blockHeading">
                            Contact Information</h3>
                        <div id="dvContactInfoReadOnly" class="ui-grid-a">
                            <div class="ui-block-a" style="padding: 0.5em 0.5em 0.5em 0.5em">
                                Your Id:</div>
                            <div id="id" class="ui-block-b" style="padding: 0.5em 0.5em 0.5em 0.5em">
                            </div>
                            <div class="ui-block-a" style="padding: 0.5em 0.5em 0.5em 0.5em">
                                Address 1:</div>
                            <div id="adrs1" class="ui-block-b" style="padding: 0.5em 0.5em 0.5em 0.5em">
                            </div>
                            <div class="ui-block-a" style="padding: 0.5em 0.5em 0.5em 0.5em">
                                Address 2:</div>
                            <div id="adrs2" class="ui-block-b" style="padding: 0.5em 0.5em 0.5em 0.5em">
                            </div>
                            <div class="ui-block-a" style="padding: 0.5em 0.5em 0.5em 0.5em">
                                City:</div>
                            <div id="city" class="ui-block-b" style="padding: 0.5em 0.5em 0.5em 0.5em">
                            </div>
                            <div class="ui-block-a" style="padding: 0.5em 0.5em 0.5em 0.5em">
                                State:</div>
                            <div id="state" class="ui-block-b" style="padding: 0.5em 0.5em 0.5em 0.5em">
                            </div>
                            <div class="ui-block-a" style="padding: 0.5em 0.5em 0.5em 0.5em">
                                Post Code:</div>
                            <div id="pc" class="ui-block-b" style="padding: 0.5em 0.5em 0.5em 0.5em">
                            </div>
                            <div class="ui-block-a" style="padding: 0.5em 0.5em 0.5em 0.5em">
                                Mob. Phone:</div>
                            <div id="phMob" class="ui-block-b" style="padding: 0.5em 0.5em 0.5em 0.5em">
                            </div>
                            <div class="ui-block-a" style="padding: 0.5em 0.5em 0.5em 0.5em">
                                Home Phone:</div>
                            <div id="phHome" class="ui-block-b" style="padding: 0.5em 0.5em 0.5em 0.5em">
                            </div>
                            <div class="ui-block-a" style="padding: 0.5em 0.5em 0.5em 0.0em">
                                <a id="lnkEditContactInfo" href="#" data-role="button" data-inline="true" data-transition="flow"
                                    data-theme="b" data-mini="true">Edit</a>
                            </div>
                        </div>
                        <div id="dvContactInfoEdit" class="ui-grid-a" style="display: none">
                            <div class="ui-block-a" style="padding: 0.5em 0.5em 0.5em 0.5em">
                                Your Id:</div>
                            <div id="idEdit" class="ui-block-b" style="padding: 0.5em 0.5em 0.5em 0.5em">
                            </div>
                            <div class="ui-block-a" style="padding: 0.5em 0.5em 0.5em 0.5em">
                                Address 1:</div>
                            <input id="adrs1Edit" class="ui-block-b" style="padding: 0.5em 0.5em 0.5em 0.5em"
                                data-mini="true" />
                            <div class="ui-block-a" style="padding: 0.5em 0.5em 0.5em 0.5em">
                                Address 2:</div>
                            <input id="adrs2Edit" class="ui-block-b" style="padding: 0.5em 0.5em 0.5em 0.5em"
                                data-mini="true" />
                            <div class="ui-block-a" style="padding: 0.5em 0.5em 0.5em 0.5em">
                                City:</div>
                            <input id="cityEdit" class="ui-block-b" style="padding: 0.5em 0.5em 0.5em 0.5em"
                                data-mini="true" />
                            <div class="ui-block-a" style="padding: 0.5em 0.5em 0.5em 0.5em">
                                State:</div>
                            <input id="stateEdit" class="ui-block-b" style="padding: 0.5em 0.5em 0.5em 0.5em"
                                data-mini="true" />
                            <div class="ui-block-a" style="padding: 0.5em 0.5em 0.5em 0.5em">
                                Post Code:</div>
                            <input id="pcEdit" class="ui-block-b" style="padding: 0.5em 0.5em 0.5em 0.5em" data-mini="true" />
                            <div class="ui-block-a" style="padding: 0.5em 0.5em 0.5em 0.5em">
                                Mob. Phone:</div>
                            <input id="phMobEdit" class="ui-block-b" style="padding: 0.5em 0.5em 0.5em 0.5em"
                                data-mini="true" />
                            <div class="ui-block-a" style="padding: 0.5em 0.5em 0.5em 0.5em">
                                Home Phone:</div>
                            <input id="phHomeEdit" class="ui-block-b" style="padding: 0.5em 0.5em 0.5em 0.5em"
                                data-mini="true" />
                            <div class="ui-block-a" style="padding: 0.5em 0.5em 0.5em 0.0em">
                                <div id="lblContactInfoSaveMsg" style="display: none; color: #8B0000;">
                                    Try Again!</div>
                                <a id="lnkSaveContactInfo" href="#" data-role="button" data-inline="true" data-transition="flow"
                                    data-theme="b" data-mini="true">Save</a> <a id="lnkCancelEditContactInfo" href="#"
                                        data-role="button" data-inline="true" data-transition="flow" data-theme="b" data-mini="true">
                                        Cancel</a>
                            </div>
                        </div>
                    </div>
                    <div data-role="collapsible" data-collapsed="true">
                        <h3 class="col_Head blockHeading">
                            Change Password</h3>
                        <div id="dvPwdInfo" class="ui-grid-a">
                            <div class="ui-block-a" style="padding: 0.5em 0.5em 0.5em 0.5em">
                                New Password:</div>
                            <input id="pwdNew" type="password" class="ui-block-b" style="padding: 0.5em 0.5em 0.5em 0.5em"
                                data-mini="true" />
                            <div class="ui-block-a" style="padding: 0.5em 0.5em 0.5em 0.5em">
                                Confirm Password:</div>
                            <input id="pwdConfirm" type="password" class="ui-block-b" style="padding: 0.5em 0.5em 0.5em 0.5em"
                                data-mini="true" />
                            <div class="ui-block-a" style="padding: 0.5em 0.5em 0.5em 0.0em">
                                <div id="lblPwdInfoSaveMsg" style="display: none; color: #8B0000;">
                                    Try Again!</div>
                                <a id="lnkUpdatePwd" href="#" data-role="button" data-inline="true" data-transition="flow"
                                    data-theme="b" data-mini="true">Update</a>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="dvNotLoggedIn" style="display: none">
                    You are not logged in yet! <a id="lnkSignIn" href="MyProfile.htm" data-role="button"
                        data-inline="true" data-transition="flow" data-theme="b" data-mini="true">Log in</a>
                    now.
                </div>
            </div>
        </div>
        <script type="text/javascript">

            ProdLine.ClassMyProfilePage = function () {

                var pgRegInfoCallback = function (data) {
                    $("#fn", $.mobile.activePage[0]).text(data.FirstName);
                    $("#ln", $.mobile.activePage[0]).text(data.LastName);
                    $("#em", $.mobile.activePage[0]).text(data.Email);

                    $("#fnEdit", $.mobile.activePage[0]).val(data.FirstName);
                    $("#lnEdit", $.mobile.activePage[0]).val(data.LastName);
                    $("#emEdit", $.mobile.activePage[0]).text(data.Email); //div

                    $("#dvProfileInfo", $.mobile.activePage[0]).show();
                };

                var pgContactInfoCallback = function (data) {
                    if (data) {

                        $("#adrs1", $.mobile.activePage[0]).text(data.Address1);
                        $("#adrs2", $.mobile.activePage[0]).text(data.Address2);
                        $("#city", $.mobile.activePage[0]).text(data.City);
                        $("#state", $.mobile.activePage[0]).text(data.State);
                        $("#pc", $.mobile.activePage[0]).text(data.PostCode);
                        $("#phMob", $.mobile.activePage[0]).text(data.PhoneMob);
                        $("#phHome", $.mobile.activePage[0]).text(data.PhoneHome);

                        $("#adrs1Edit", $.mobile.activePage[0]).val(data.Address1);
                        $("#adrs2Edit", $.mobile.activePage[0]).val(data.Address2);
                        $("#cityEdit", $.mobile.activePage[0]).val(data.City);
                        $("#stateEdit", $.mobile.activePage[0]).val(data.State);
                        $("#pcEdit", $.mobile.activePage[0]).val(data.PostCode);
                        $("#phMobEdit", $.mobile.activePage[0]).val(data.PhoneMob);
                        $("#phHomeEdit", $.mobile.activePage[0]).val(data.PhoneHome);

                        $("#dvContactInfo", $.mobile.activePage[0]).show();
                    }

                    $("#id", $.mobile.activePage[0]).text(ProdLine.Shared.ContextUser.CustomerId);
                    $("#idEdit", $.mobile.activePage[0]).text(ProdLine.Shared.ContextUser.CustomerId);
                    $.mobile.loading('hide');
                };

                var pgSaveRegInfoCallback = function (result) {
                    if (result == true) {
                        $("#fn", $.mobile.activePage[0]).text($("#fnEdit", $.mobile.activePage[0]).val());
                        $("#ln", $.mobile.activePage[0]).text($("#lnEdit", $.mobile.activePage[0]).val());

                        $("#lnkCancelEditRegInfo", $.mobile.activePage[0]).click(); //save is done, show read-only mode now
                    }
                    else {
                        $("#lblRegInfoSaveMsg", $.mobile.activePage[0]).show();
                    }
                    $.mobile.loading('hide');
                };

                var pgSaveContactInfoCallback = function (result) {
                    if (result == true) {
                        $("#adrs1", $.mobile.activePage[0]).text($("#adrs1Edit", $.mobile.activePage[0]).val());
                        $("#adrs2", $.mobile.activePage[0]).text($("#adrs2Edit", $.mobile.activePage[0]).val());
                        $("#city", $.mobile.activePage[0]).text($("#cityEdit", $.mobile.activePage[0]).val());
                        $("#state", $.mobile.activePage[0]).text($("#stateEdit", $.mobile.activePage[0]).val());
                        $("#pc", $.mobile.activePage[0]).text($("#pcEdit", $.mobile.activePage[0]).val());
                        $("#phMob", $.mobile.activePage[0]).text($("#phMobEdit", $.mobile.activePage[0]).val());
                        $("#phHome", $.mobile.activePage[0]).text($("#phHomeEdit", $.mobile.activePage[0]).val());

                        $("#lnkCancelEditContactInfo", $.mobile.activePage[0]).click(); //save is done, show read-only mode now
                    }
                    else {
                        $("#lblContactInfoSaveMsg", $.mobile.activePage[0]).show();
                    }
                    $.mobile.loading('hide');
                };

                var pgUpdatePasswordCallback = function (result) {
                    if (result == true) {
                        $("#pwdNew", $.mobile.activePage[0]).val("");
                        $("#pwdConfirm", $.mobile.activePage[0]).val("");
                    }
                    else {
                        $("#lblPwdInfoSaveMsg", $.mobile.activePage[0]).show();
                    }
                    $.mobile.loading('hide');
                };

                this.CanShow = function () {
                    return ProdLine.Shared.ContextUser.IsLoggedIn() && ProdLine.Shared.ContextUser.IsSessionSecured();
                };

                this.LoadRegInfo = function () {
                    $.when(ProdLine.Provider.Customer.GetRegInfo()).done(function (data) {
                        pgRegInfoCallback(data);
                    });
                };

                this.LoadContactInfo = function () {
                    $.when(ProdLine.Provider.Customer.GetContactInfo()).done(function (data) {
                        pgContactInfoCallback(data);
                    });
                };

                this.Init = function () {
                    $("#lnkEditRegInfo", $.mobile.activePage[0]).on('click', function () {
                        $("#dvRegInfoReadOnly", $.mobile.activePage[0]).hide();
                        $("#dvRegInfoEdit", $.mobile.activePage[0]).show();
                        $("#lblRegInfoSaveMsg", $.mobile.activePage[0]).hide();
                        return false;
                    });

                    $("#lnkCancelEditRegInfo", $.mobile.activePage[0]).on('click', function () {
                        $("#dvRegInfoReadOnly", $.mobile.activePage[0]).show();
                        $("#dvRegInfoEdit", $.mobile.activePage[0]).hide();
                        $("#lblRegInfoSaveMsg", $.mobile.activePage[0]).hide();
                        return false;
                    });

                    $("#lnkEditContactInfo", $.mobile.activePage[0]).on('click', function () {
                        $("#dvContactInfoReadOnly", $.mobile.activePage[0]).hide();
                        $("#dvContactInfoEdit", $.mobile.activePage[0]).show();
                        return false;
                    });

                    $("#lnkCancelEditContactInfo", $.mobile.activePage[0]).on('click', function () {
                        $("#dvContactInfoReadOnly", $.mobile.activePage[0]).show();
                        $("#dvContactInfoEdit", $.mobile.activePage[0]).hide();
                        return false;
                    });

                    $("#lnkSaveRegInfo", $.mobile.activePage[0]).on('click', function () {
                        $.mobile.loading('show');
                        $("#lblRegInfoSaveMsg", $.mobile.activePage[0]).hide();
                        var firstName = $("#fnEdit", $.mobile.activePage[0]).val();
                        var lastName = $("#lnEdit", $.mobile.activePage[0]).val();
                        ProdLine.Provider.Customer.UpdateRegInfoWithCallback({ FirstName: firstName, LastName: lastName }, pgSaveRegInfoCallback);
                        return false;
                    });

                    $("#lnkSaveContactInfo", $.mobile.activePage[0]).on('click', function () {
                        $.mobile.loading('show');
                        $("#lblContactInfoSaveMsg", $.mobile.activePage[0]).hide();
                        ProdLine.Provider.Customer.UpdateContactInfoWithCallback({
                            Address1: $("#adrs1Edit", $.mobile.activePage[0]).val(),
                            Address2: $("#adrs2Edit", $.mobile.activePage[0]).val(),
                            City: $("#cityEdit", $.mobile.activePage[0]).val(),
                            State: $("#stateEdit", $.mobile.activePage[0]).val(),
                            PostCode: $("#pcEdit", $.mobile.activePage[0]).val(),
                            PhoneMob: $("#phMobEdit", $.mobile.activePage[0]).val(),
                            PhoneHome: $("#phHomeEdit", $.mobile.activePage[0]).val()
                        }, pgSaveContactInfoCallback);
                        return false;
                    });

                    $("#lnkUpdatePwd", $.mobile.activePage[0]).on('click', function () {
                        $.mobile.loading('show');
                        $("#lblPwdInfoSaveMsg", $.mobile.activePage[0]).hide();
                        var pwd = $("#pwdNew", $.mobile.activePage[0]).val();
                        if (pwd != $("#pwdConfirm", $.mobile.activePage[0]).val()) {
                            $("#lblPwdInfoSaveMsg", $.mobile.activePage[0]).show();
                            $.mobile.loading('hide');
                            return false;
                        }
                        ProdLine.Provider.Customer.UpdateRegInfoWithCallback({ Password: pwd }, pgUpdatePasswordCallback);
                        return false;
                    });

                };

            };

            var profilePage = new ProdLine.ClassMyProfilePage();

            $("#pgMyProfile").one("pagebeforeshow", function () {
                if (!profilePage.CanShow()) {

                    ////The following works in browser (as popup dialog). But does not work on device
                    //$.mobile.changePage("Login.htm", {
                    //    //role: 'dialog',
                    //    reloadPage: true,
                    //    type: 'get',
                    //    changeHash: false //or fromHashChange:true //cancelling popup should return to previous page
                    //});

                    //changed to normal page using the following
                    $.mobile.changePage("LoginPage.htm", { changeHash: false });
                }
            });

            $("#pgMyProfile").one("pageshow", function () {
                $.mobile.loading('show');
                if (profilePage.CanShow()) {
                    profilePage.Init();
                    profilePage.LoadRegInfo();
                    profilePage.LoadContactInfo();
                } else {
                    $("#dvNotLoggedIn", $.mobile.activePage[0]).show();
                    $.mobile.loading('hide');
                }
            });

        </script>
    </div>
</body>
</html>
