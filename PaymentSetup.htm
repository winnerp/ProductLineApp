<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title></title>
    <link href="css/jquery.mobile-1.2.0.min.css" rel="stylesheet" type="text/css" />
    <script src="js/jquery-1.8.2.js" type="text/javascript"></script>
    <script src="js/jquery.mobile-1.2.0.js" type="text/javascript"></script>
    <script src="js/jqm.page.params.js" type="text/javascript"></script>
    <script src="js/jquery.formatCurrency-1.4.0.js" type="text/javascript"></script>
    <script src="js/purl.js" type="text/javascript"></script>
    <script src="js/Base64.js" type="text/javascript"></script>
    <script src="js/json2.js" type="text/javascript"></script>
    <script src="js/ProdLine.Utils.js" type="text/javascript"></script>
    <script src="js/ProdLine.Shared.js" type="text/javascript"></script>
    <script src="js/ProdLine.Provider.js" type="text/javascript"></script>
</head>
<body>
    <div id="pgPaymentSetup" data-role="page" data-theme="d">
        <div data-role="header" data-theme="b">
            <a href="index.html" class="ui-btn-left" data-icon="home" data-role="button" data-theme="b"
                data-iconpos="notext" data-transition="slide"></a>
            <h1>
                Product Line</h1>
            <div style="padding: .5em; background-color: #C0C0C0">
                <div data-role="navbar">
                    <fieldset class="ui-grid-b">
                        <div class="ui-block-a" style="margin-left: 0px; margion-right: 0px">
                            <a data-theme="d" href="MyProfile.htm" class="ui-corner-left" data-corners="true"
                                style="width: 100%; margin-left: 0px; margin-right: 0px" data-role="button" data-theme="d"
                                data-icon="star" data-iconpos="top">My Profile</a>
                        </div>
                        <div class="ui-block-b" style="margin-left: 0px; margion-right: 0px">
                            <a data-theme="d" href="#" class="ui-btn-active" style="width: 100%; margin-left: 0px;
                                margin-right: 0px" data-role="button" data-theme="d" data-icon="gear" data-iconpos="top">
                                Payment Setup</a>
                        </div>
                        <div class="ui-block-c" style="margin-left: 0px; margion-right: 0px">
                            <a data-theme="d" href="MyOrders.htm" class="ui-corner-right ui-controlgroup-last"
                                data-corners="true" style="width: 100%; margin-left: 0px; margin-right: 0px"
                                data-role="button" data-theme="d" data-icon="grid" data-iconpos="top">My Orders</a>
                        </div>
                    </fieldset>
                </div>
            </div>
        </div>
        <div data-role="content" data-theme="d">
            <div id="dvPaymentInfo" style="display: none">
                <div data-role="collapsible-set">
                    <div data-role="collapsible" data-collapsed="false">
                        <h3 class="col_Head blockHeading">
                            Your registered payment Info</h3>
                        <div id="dvPaymentInfoReadOnly" class="ui-grid-a">
                            <div class="ui-block-a" style="padding: 0.5em 0.5em 0.5em 0.5em">
                                Name on Card:</div>
                            <div id="noc" class="ui-block-b" style="padding: 0.5em 0.5em 0.5em 0.5em">
                            </div>
                            <div class="ui-block-a" style="padding: 0.5em 0.5em 0.5em 0.5em">
                                Card No.:</div>
                            <div id="cn" class="ui-block-b" style="padding: 0.5em 0.5em 0.5em 0.5em">
                            </div>
                            <div class="ui-block-a" style="padding: 0.5em 0.5em 0.5em 0.5em">
                                Card Type:</div>
                            <div id="ct" class="ui-block-b" style="padding: 0.5em 0.5em 0.5em 0.5em">
                            </div>
                            <div class="ui-block-a" style="padding: 0.5em 0.5em 0.5em 0.5em">
                                Expiry Date:</div>
                            <div id="ed" class="ui-block-b" style="padding: 0.5em 0.5em 0.5em 0.5em">
                            </div>
                            <div class="ui-block-a" style="padding: 0.5em 0.5em 0.5em 0.0em">
                                <a id="lnkEditPaymentInfo" href="#" data-role="button" data-inline="true" data-transition="flow"
                                    data-theme="b" data-mini="true">Edit</a>
                            </div>
                        </div>
                        <div id="dvPaymentInfoEdit" class="ui-grid-a" style="display: none">
                            <div class="ui-block-a" style="padding: 0.5em 0.5em 0.5em 0.5em">
                                Name on Card:</div>
                            <input id="nocEdit" class="ui-block-b" style="padding: 0.5em 0.5em 0.5em 0.5em" data-mini="true" />
                            <div class="ui-block-a" style="padding: 0.5em 0.5em 0.5em 0.5em">
                                Card No.:</div>
                            <input id="cnEdit" class="ui-block-b" style="padding: 0.5em 0.5em 0.5em 0.5em" data-mini="true" />
                            <div class="ui-block-a" style="padding: 0.5em 0.5em 0.5em 0.5em">
                                Card Type:</div>
                            <input id="ctEdit" class="ui-block-b" style="padding: 0.5em 0.5em 0.5em 0.5em" data-mini="true" />
                            <div class="ui-block-a" style="padding: 0.5em 0.5em 0.5em 0.5em">
                                Expiry Date:</div>
                            <input id="edEdit" class="ui-block-b" style="padding: 0.5em 0.5em 0.5em 0.5em" data-mini="true" />
                            <div class="ui-block-a" style="padding: 0.5em 0.5em 0.5em 0.0em">
                                <div id="lblPaymentInfoSaveMsg" style="display: none; color: #8B0000;">
                                    Try Again!</div>
                                <a id="lnkSavePaymentInfo" href="#" data-role="button" data-inline="true" data-transition="flow"
                                    data-theme="b" data-mini="true">Save</a> <a id="lnkCancelEditPaymentInfo" href="#"
                                        data-role="button" data-inline="true" data-transition="flow" data-theme="b" data-mini="true">
                                        Cancel</a>
                            </div>
                        </div>
                    </div>
                    <div id="dvNotLoggedIn" style="display: none">
                        You are not logged in yet! <a id="lnkSignIn" href="PaymentSetup.htm" data-role="button"
                            data-inline="true" data-transition="flow" data-theme="b" data-mini="true">Log in</a>
                        now.
                    </div>
                </div>
            </div>
            <script type="text/javascript">

                ProdLine.ClassPaymentInfoPage = function () {

                    this.CanShow = function () {
                        return ProdLine.Shared.ContextUser.IsLoggedIn() && ProdLine.Shared.ContextUser.IsSessionSecured();
                    };

                    var pgPaymentInfoCallback = function (data) {
                        if (data) {
                            $("#noc", $.mobile.activePage[0]).text(data.NameOnCard);
                            $("#cn", $.mobile.activePage[0]).text(data.CardNo);
                            $("#ct", $.mobile.activePage[0]).text(data.PaymentCardType);
                            $("#ed", $.mobile.activePage[0]).text(data.ExpDate);

                            $("#nocEdit", $.mobile.activePage[0]).val(data.NameOnCard);
                            $("#cnEdit", $.mobile.activePage[0]).val(data.CardNo);
                            $("#ctEdit", $.mobile.activePage[0]).val(data.PaymentCardType);
                            $("#edEdit", $.mobile.activePage[0]).val(data.ExpDate);
                        }

                        $("#dvPaymentInfo", $.mobile.activePage[0]).show();
                        $.mobile.loading('hide');
                    };

                    var pgSavePaymentInfoCallback = function (result) {
                        debugger;
                        if (result == true) {
                            $("#noc", $.mobile.activePage[0]).text($("#nocEdit", $.mobile.activePage[0]).val());
                            $("#cn", $.mobile.activePage[0]).text($("#cnEdit", $.mobile.activePage[0]).val());
                            $("#ct", $.mobile.activePage[0]).text($("#ctEdit", $.mobile.activePage[0]).val());
                            $("#ed", $.mobile.activePage[0]).text($("#edEdit", $.mobile.activePage[0]).val());

                            $("#lnkCancelEditPaymentInfo", $.mobile.activePage[0]).click(); //save is done, show read-only mode now
                        }
                        else {
                            $("#lblPaymentInfoSaveMsg", $.mobile.activePage[0]).show();
                        }
                        $.mobile.loading('hide');
                    };

                    this.LoadPaymentInfo = function () {
                        ProdLine.Provider.Customer.GetPaymentInfoWithCallback(pgPaymentInfoCallback);
                    };

                    this.Init = function () {

                        $("#lnkEditPaymentInfo", $.mobile.activePage[0]).on('click', function () {
                            $("#dvPaymentInfoReadOnly", $.mobile.activePage[0]).hide();
                            $("#dvPaymentInfoEdit", $.mobile.activePage[0]).show();
                            $("#lblPaymentInfoSaveMsg", $.mobile.activePage[0]).hide();
                            return false;
                        });

                        $("#lnkCancelEditPaymentInfo", $.mobile.activePage[0]).on('click', function () {
                            $("#dvPaymentInfoReadOnly", $.mobile.activePage[0]).show();
                            $("#dvPaymentInfoEdit", $.mobile.activePage[0]).hide();
                            $("#lblPaymentInfoSaveMsg", $.mobile.activePage[0]).hide();
                            return false;
                        });

                        $("#lnkSavePaymentInfo", $.mobile.activePage[0]).on('click', function () {
                            $.mobile.loading('show');
                            $("#lblPaymentInfoSaveMsg", $.mobile.activePage[0]).hide();
                            var noc = $("#nocEdit", $.mobile.activePage[0]).val();
                            var cn = $("#cnEdit", $.mobile.activePage[0]).val();
                            var ct = $("#ctEdit", $.mobile.activePage[0]).val();
                            var ed = $("#edEdit", $.mobile.activePage[0]).val();
                            ProdLine.Provider.Customer.UpdatePaymentInfoWithCallback({
                                PaymentCardType: ct,
                                NameOnCard: noc,
                                CardNo: cn,
                                ExpDate: ed
                            }, pgSavePaymentInfoCallback);
                            return false;
                        });

                    };
                };

                var paymentPage = new ProdLine.ClassPaymentInfoPage();

                $("#pgPaymentSetup").one("pagebeforeshow", function () {
                    if (!paymentPage.CanShow()) {
                        //                        $.mobile.changePage("Login.htm", {
                        //                            role: 'dialog',
                        //                            reloadPage: true,
                        //                            type: 'get',
                        //                            changeHash: false //or fromHashChange:true //cancelling popup should return to previous page
                        //                        });

                        //changed to normal page using the following
                        $.mobile.changePage("LoginPage.htm");
                    }
                });

                $("#pgPaymentSetup").one("pageshow", function () {
                    $.mobile.loading('show');
                    if (paymentPage.CanShow()) {
                        paymentPage.Init();
                        paymentPage.LoadPaymentInfo();
                        $.mobile.loading('hide');
                    } else {
                        $("#dvNotLoggedIn", $.mobile.activePage[0]).show();
                        $.mobile.loading('hide');
                    }
                });

            </script>
        </div>
    </div>
</body>
</html>
